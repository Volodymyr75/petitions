name: Daily Sync

on:
  schedule:
    # Run at 04:00 UTC (06:00 Kyiv time)
    - cron: '0 4 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      skip_preflight:
        description: 'Skip pre-flight validation'
        type: boolean
        default: false
      notify_success:
        description: 'Send Telegram notification on success'
        type: boolean
        default: false

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install duckdb requests beautifulsoup4
      
      - name: Run Cloud Sync
        id: sync
        env:
          MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd etl
          ARGS=""
          if [ "${{ github.event.inputs.skip_preflight }}" == "true" ]; then
            ARGS="$ARGS --skip-preflight"
          fi
          if [ "${{ github.event.inputs.notify_success }}" == "true" ]; then
            ARGS="$ARGS --notify-success"
          fi
          python cloud_sync.py $ARGS
      
      - name: Commit and push analytics JSON
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/analytics_data.json
          git diff --cached --quiet || git commit -m "data: automated daily sync $(date +%Y-%m-%d)"
          git push
      
      - name: Create failure issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Sync Failed] ${date}`,
              body: `## Automated Sync Failure\n\n**Date:** ${date}\n**Workflow Run:** [Link](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n### Action Required\n\nPlease check the workflow logs for details and fix the issue.\n\nPossible causes:\n- Website structure changed\n- Network issues\n- Rate limiting`,
              labels: ['bug', 'automation']
            });
